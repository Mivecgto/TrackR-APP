<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrackR - Farm Stock Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: lightgreen;
      margin: 20px;
    }
    .farm, .paddock {
      border: 1px solid #333;
      background: #fff;
      padding: 10px;
      margin: 5px 0;
    }
    button {
      margin: 5px;
    }
    .transfer-box {
      background: #eef;
      padding: 10px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>TrackR - Farm Stock Tracker</h1>

  <div id="app"></div>

  <script>
    const app = document.getElementById('app');

    let farms = JSON.parse(localStorage.getItem('farms')) || [];
    let paddocks = JSON.parse(localStorage.getItem('paddocks')) || {};
    let stock = JSON.parse(localStorage.getItem('stock')) || {};
    let selectedFarm = null;

    function saveData() {
      localStorage.setItem('farms', JSON.stringify(farms));
      localStorage.setItem('paddocks', JSON.stringify(paddocks));
      localStorage.setItem('stock', JSON.stringify(stock));
    }

    function render() {
      app.innerHTML = '';

      if (!selectedFarm) {
        const input = document.createElement('input');
        input.placeholder = "Enter Farm Name";

        const addBtn = document.createElement('button');
        addBtn.textContent = "Add Farm";
        addBtn.onclick = () => {
          if (input.value.trim()) {
            farms.push(input.value.trim());
            paddocks[input.value.trim()] = [];
            saveData();
            render();
          }
        };

        app.appendChild(input);
        app.appendChild(addBtn);

        farms.forEach(farm => {
          const div = document.createElement('div');
          div.className = 'farm';
          div.textContent = `${farm}`;
          div.onclick = () => {
            selectedFarm = farm;
            render();
          };
          app.appendChild(div);
        });

      } else {
        const backBtn = document.createElement('button');
        backBtn.textContent = "Back to Farms";
        backBtn.onclick = () => {
          selectedFarm = null;
          render();
        };
        app.appendChild(backBtn);

        const paddockInput = document.createElement('input');
        paddockInput.placeholder = "Enter Paddock Name";

        const addPaddockBtn = document.createElement('button');
        addPaddockBtn.textContent = "Add Paddock";
        addPaddockBtn.onclick = () => {
          if (paddockInput.value.trim()) {
            paddocks[selectedFarm].push(paddockInput.value.trim());
            saveData();
            render();
          }
        };

        app.appendChild(paddockInput);
        app.appendChild(addPaddockBtn);

        paddocks[selectedFarm].forEach(paddock => {
          const key = `${selectedFarm}-${paddock}`;
          const paddockDiv = document.createElement('div');
          paddockDiv.className = 'paddock';
          const stockCount = stock[key] ? 
            Object.entries(stock[key]).map(([type, count]) => `${type}: ${count}`).join(', ') 
            : "No stock";

          paddockDiv.innerHTML = `<strong>${paddock}</strong> (${stockCount})`;

          const addStockBtn = document.createElement('button');
          addStockBtn.textContent = "Add Stock";
          addStockBtn.onclick = () => {
            const type = prompt("Enter Stock Type (Ewes, Rams, etc):");
            const qty = parseInt(prompt("Enter Quantity:"), 10);
            if (!stock[key]) stock[key] = {};
            stock[key][type] = (stock[key][type] || 0) + qty;
            saveData();
            render();
          };
          paddockDiv.appendChild(addStockBtn);

          const transferBtn = document.createElement('button');
          transferBtn.textContent = "Transfer Stock";
          transferBtn.onclick = () => showTransferForm(paddock);
          paddockDiv.appendChild(transferBtn);

          app.appendChild(paddockDiv);
        });
      }
    }

    function showTransferForm(sourcePaddock) {
      const key = `${selectedFarm}-${sourcePaddock}`;
      const formDiv = document.createElement('div');
      formDiv.className = 'transfer-box';

      const stockTypes = stock[key] ? Object.keys(stock[key]) : [];
      if (stockTypes.length === 0) {
        alert("No stock to transfer.");
        return;
      }

      const stockSelect = document.createElement('select');
      stockTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        stockSelect.appendChild(option);
      });

      const qtyInput = document.createElement('input');
      qtyInput.type = "number";
      qtyInput.placeholder = "Quantity";

      const destSelect = document.createElement('select');
      paddocks[selectedFarm].filter(p => p !== sourcePaddock).forEach(dest => {
        const option = document.createElement('option');
        option.value = dest;
        option.textContent = dest;
        destSelect.appendChild(option);
      });

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = "Confirm Transfer";
      confirmBtn.onclick = () => {
        const type = stockSelect.value;
        const qty = parseInt(qtyInput.value, 10);
        const dest = destSelect.value;
        if (!dest || qty <= 0) return;

        if (!stock[key][type] || stock[key][type] < qty) {
          alert("Not enough stock to transfer.");
          return;
        }

        stock[key][type] -= qty;
        const destKey = `${selectedFarm}-${dest}`;
        if (!stock[destKey]) stock[destKey] = {};
        stock[destKey][type] = (stock[destKey][type] || 0) + qty;

        saveData();
        render();
      };

      formDiv.appendChild(stockSelect);
      formDiv.appendChild(qtyInput);
      formDiv.appendChild(destSelect);
      formDiv.appendChild(confirmBtn);
      app.appendChild(formDiv);
    }

    render();
  </script>
</body>
</html>
